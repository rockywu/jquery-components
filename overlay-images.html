<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>jQuery叠层播放插件</title>

<style type="text/css">
*{
	margin: 0;
	padding: 0;
}

img{
	width: 751px;
	height: 300px;
	border:none;
}

</style>

</head>
<body>
<div class="overlay" id="overlay">
	<div class="ol-item ol6"><a><img src="img/3.png" alt="" /></a></div>
	<div class="ol-item ol4"><a><img src="img/1.png" alt="" /></a></div>
	<div class="ol-item"><a><img src="img/44.jpg" alt="" /></a></div>
	<div class="ol-item ol5"><a><img src="img/2.png" alt="" /></a></div>
</div>
<script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
<style>
	.overlay {
    overflow: hidden;
	}
	.overlay > .ol-item{
		position: absolute;
		top: 0;
		left: 0;
		-webkit-transition: all 0.3s ease-out;
		transition: all 0.3s ease-out;
	}
</style>
<script type="text/javascript">
/**
 * 叠层翻页插件动画，基于jquery
 */
(function(window, $) {

	//上一张切换
	function prev(children, indexArr){
		indexArr.push(indexArr[0]);
		indexArr.shift();
		$(children).each(function(i,e){
			$(e).css(indexArr[i].styles)
		})
	}

	//下一张切换
	function next(children, indexArr){
		indexArr.unshift(indexArr[indexArr.length - 1]);
		indexArr.pop();
		$(children).each(function(i,e){
			$(e).css(indexArr[i].styles)
		})
	}

	/**
	 * 叠层插件
	 * @param {String} elm 根元素选择器
	 * @options {Object} options
	 * {
	 * 	auto : false, //是否自动播放
	 * 	interval: 4000, //默认自动播放间隔时间
	 * 	layerNum: 3, //可展示元素数量
	 * 	change: function(index, el) {}, //切换时回调函数
	 * }
	 */
	function Overlay(elm, options) {
		var that = this;
		options = options || {}
		layerNum = options.layerNum || 3;
		var elm = $(elm);
		var children = elm.children()
		if(elm.length < 1 || children.length < layerNum || (layerNum !== 3 && layerNum !==5) ) {
			throw new Error("参数存在错误")
		}
		//如果children.length == layerNum时需要copy元素
		if(children.length === layerNum) {
			elm.append(children.clone())
			children = elm.children()
		}
		var childWidth = children.width();
		var scale = 0.8;
		var step = 0.4;
		var width = parseInt(childWidth * scale * step, 10);

		var indexArr = [];
		//设置元素索引
		children.each(function(k, v) {
			$(v).attr("ol-index", k)
			var params = {
				"-webkit-transform": "translate3d(" + (k - 1) * width + "px,0,0) scale("+scale+")",
				"transform" : "translate3d(" + (k - 1) * width + "px,0,0) scale("+scale+")",
				"opacity": 0,
				"z-index": 1,
				"-webkit-transform-origin": "0% 0%",
				"transform-origin": "0% 0%"
			}
			var tmp = parseInt(layerNum/2, 10)
			if(k == tmp) {
				params["opacity"] = 0.3
				params["z-index"] = 2
				params["-webkit-transform-origin"] = "0% 0%"
				params["transform-origin"] = "0 50%"
			} else if(k == tmp + 1) {
				params["-webkit-transform"] = "translate3d(" + (k - 1) * width + "px,0,0) scale(1)"
				params["transform"] = "translate3d(" + (k - 1) * width + "px,0,0) scale(1)"
				params["opacity"] = 1
				params["z-index"] = 3;
			} else if(k == tmp + 2) {
				params["opacity"] = 0.3
				params["z-index"] = 2
				params["-webkit-transform-origin"] = "0% 0%"
				params["transform-origin"] = "100% 50%"
			}
			$(v).css(params)
			indexArr.push({
				selecter: "[ol-index="+k+"]",
				styles: params
			})
		});

		//定时器
		var timer = null
		options.interval = parseInt(options.interval, 10) || 4000
		var autoPlay = function () {
			if(options.auto !== true) {
				return;
			}
			if(timer) {
				clearInterval(timer)
			}
			timer = setInterval(function() {
				that.next();
			}, options.interval)
		}

		autoPlay();

		this.index = 0;

		//设置调度函数
		this.next = function() {
			this.index++
			if(this.index > indexArr.length - 1) {
				this.index = 0
			}
			next(children, indexArr)
			if(options && typeof options.change == 'function') {
				options.change(this.index, children.filter(indexArr[this.index].selecter).get(0))
			}
			autoPlay()
		}

		//设置调度函数
		this.prev = function() {
			this.index--
			if(this.index < 0) {
				this.index = indexArr.length - 1
			}
			prev(children, indexArr)
			if(options && typeof options.change == 'function') {
				options.change(this.index, children.filter(indexArr[this.index].selecter).get(0))
			}
			autoPlay()
		}

		// 鼠标移入box时清除定时器
		elm.mouseover(function(){
			console.log("mouseover")
			clearInterval(timer);
		})

		// 鼠标移出box时开始定时器
		elm.mouseleave(function(){
			console.log("mouseleave")
			autoPlay()
		})

	}

	window.Overlay = Overlay;
})(window, window.jQuery)


var firstOverlay = new window.Overlay("#overlay", {
	auto: true,
	interval: 1000,
	change(index, dom) {
		console.log(index, dom)
	}
});
	
</script>

</body>
</html>
